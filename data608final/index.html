<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="SHORTCUT ICON" type="image/x-icon" href="/favicon.ico">

    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />

    <title>Earth globe</title>
    <script src="//d3js.org/d3.v3.min.js"></script>
    <script src="//d3js.org/topojson.v1.min.js"></script>
    <script src="//d3js.org/queue.v1.min.js"></script>

</head>
<style type="text/css">
    body {
        margin: auto;
        width: 700px;
        border: 20px solid #EEEEEE;
        padding: 10px;
    }

    #app {
        text-align: center;
    }

    .water {
        fill: #00248F;
    }

    .land {
        //fill: #A98B6F;
        stroke: #333333;
        stroke-width: 0.7px;
    }

    .land:hover {
        //fill:#33CC33;
        stroke-width: 1px;
    }

    .focused {
        //fill: #33CC33;
    }

    .selectBoxLabel {
        width: 200px;
    }

    .selectBoxClazz {
        width: 250px;
    }

    select {
        border: solid #ccc 1px;
        padding: 3px;
        padding: 5px;
        margin: 5px;
    }

    .countryTooltip {
        position: absolute;
        display: none;
        pointer-events: none;
        background: #fff;
        padding: 5px;
        text-align: left;
        border: solid #ccc 1px;
        color: #666;
        font-size: 14px;
        font-family: sans-serif;
    }
</style>

<body>

    <div id="app">

        <i>(Mouse over countries to see value of selected statistic)</i>
        <h1 id="titleTextID">titleTextID</h1>


        <fieldset>

            <div>
                <label class="selectBoxLabel" for="charts">Select Chart:</label>
                <select class="selectBoxClazz" name="charts" id="charts">
				<option value="HEALTH_EXPENDITURE_PER_CAPITA">Health Expenditure Per Capita</option>
				<option value="LIFE_EXPECTANCY_AT_BIRTH">Life Expectancy at Birth</option>
				<option value="GOV_DEBT_PCT_OF_GDP">Gov Debt Pct. of GDP</option>
				<option value="GDP_PER_CAPITA">GDP per Capita</option>
				<option value="IMPORTS_PCT_OF_GDP">Imports % of GDP</option>
				<option value="GOV_ED_SPEND_PCT_GDP">Gov Education Spending: Pct. of GDP</option>
				</select>
                <span id="colorSquare" style="border:1px solid #333333;width:20px;height:20px;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
            </div>

            <div>
                <label class="selectBoxLabel" for="countries">Country Focus:</label>
                <select class="selectBoxClazz" name="countries" id="countries"></select>
            </div>

            <h1 id="currentYearHeader">Year:</h1>
            <input id="yearRange" type="range" step="1" min="1960" max="2015" value="1960" />
            <input id="yearRangePlayBtn" type="button" value="Play!" />

        </fieldset>

        <div>&nbsp;</div>

        <script language="JavaScript">
        	var ANIMATION_TIMEOUT = 350;
            var green_colors_health_expenditures = ["#E9F7EF", "#D4EFDF", "#A9DFBF", "#7DCEA0", "#52BE80", "#27AE60", "#229954", "#1E8449", "#196F3D", "#145A32"];
            var red_colors_life_exp_at_birth = ["#AA0000", "#990000", "#880000", "#770000", "#660000", "#550000", "#440000", "#330000", "#220000", "#110000"];
            var purple_colors_debt_gdp = ["#a569bd", "#8e44ad", "#884ea0", "#7d3c98", "#76448a", "#6c3483", "#633974", "#5b2c6f", "#512e5f", "#4a235a"];
            var yellow_colors_gdp_per_capita = ["#FFFFEE", "#FFFFCC", "#FFFF99", "#FFFF66", "#FFFF33", "#FFFF00", "#CCCC00", "#999900", "#666600", "#333300"];
            var orange_colors_imports_2_gdp = ["#fff6e5", "#ffedcc", "#ffe4b2", "#ffdb99", "#ffd27f", "#ffc966", "#ffc04c", "#ffb732", "#ffae19", "#ffa500"];
            var blue_colors_education_pct_gdp = ["#e5e5ff", "#ccccff", "#b2b2ff", "#9999ff", "#7f7fff", "#6666ff", "#4c4cff", "#3232ff", "#1919ff", "#0000ff"];

            var DEBUG = false;
            var width = 600;
            var height = 500;
            var sens = 0.25;
            var focused;

            // Setting projection
            var projection = d3.geo.orthographic().scale(245).rotate([0, 0]).translate([width / 2, height / 2]).clipAngle(90);
            var path = d3.geo.path().projection(projection);

            //SVG container
            var svg = d3.select("#app").append("svg");
            function initSVG(){
				svg.remove();
	            svg = d3.select("#app").append("svg");
	            svg.attr("width", width).attr("height", height);
				svg.append("path").datum({
					type: "Sphere"
				}).attr("class", "water").attr("d", path);

				return svg;
            }

            svg = initSVG();

            var countryTooltip = d3.select("body").append("div").attr("class", "countryTooltip");
            var selectBoxesDiv = d3.select("body").append("div");

            d3.select("#titleTextID").text("Gov Debt Pct. of GDP");
            selectBoxesDiv.append("br")

            queue().defer(d3.json, "world-110m.json").defer(d3.tsv, "world-110m-country-names.tsv").await(ready);

            //Main function
            function ready(error, world, countryData) {

                var countryById = {};
                var countries = topojson.feature(world, world.objects.countries).features;

                countryData.forEach(function(d) {
                    countryById[d.id] = d.name;
                    option = d3.select("#countries").append("option");
                    option.text(d.name);
                    option.property("value", d.id);
                });

                function getChartTypeSelectionText() {
                    var chartTypeSelectedIndex = document.getElementById("charts");
                    var chartTypeSelectedOptionText = chartTypeSelectedIndex.options[chartTypeSelectedIndex.selectedIndex].text;
                    return chartTypeSelectedOptionText;
                }

                function getChartTypeSelectionValue() {
                    var chartTypeSelectedIndex = document.getElementById("charts");
                    var chartTypeSelectedOption = chartTypeSelectedIndex.options[chartTypeSelectedIndex.selectedIndex].value;
                    return chartTypeSelectedOption;
                }

                function setChartColorBox() {
                    var selectedChartOption = getChartTypeSelectionValue();

                    if (selectedChartOption == "HEALTH_EXPENDITURE_PER_CAPITA") {
                        d3.select("#colorSquare").style("background-color", "green");
                    } else if (selectedChartOption == "LIFE_EXPECTANCY_AT_BIRTH") {
                        d3.select("#colorSquare").style("background-color", "red");
                    } else if (selectedChartOption == "GOV_DEBT_PCT_OF_GDP") {
                        d3.select("#colorSquare").style("background-color", "purple");
                    } else if (selectedChartOption == "GDP_PER_CAPITA") {
                        d3.select("#colorSquare").style("background-color", "yellow");
                    } else if (selectedChartOption == "IMPORTS_PCT_OF_GDP") {
                        d3.select("#colorSquare").style("background-color", "orange");
                    } else if (selectedChartOption == "GOV_ED_SPEND_PCT_GDP") {
                        d3.select("#colorSquare").style("background-color", "blue");
                    }
                }

                setChartColorBox();

                updateAll(2005);

                function updateAll(yearToShow) {
                    console.log("UPDATE ALL[year=" + yearToShow + "]");
                    var noCacheURL = "data.csv" + '?' + Math.floor(Math.random() * 1000);
                    d3.csv(noCacheURL, function(data) {
                        var countryColors = [];
                        var dataForYear = data.filter(function(d, i) {
                            if (d["YEAR"] == yearToShow) {
                                return d;
                            }
                        });

                        if (DEBUG) {
                            console.log("***** (COUNTRY,YEAR,HEALTH_EXPENDITURE_PER_CAPITA,LIFE_EXPECTANCY_AT_BIRTH,GOV_DEBT_PCT_OF_GDP,GDP_PER_CAPITA,IMPORTS_PCT_OF_GDP,GOV_ED_SPEND_PCT_GDP) *****");
                        }

                        dataForYear.forEach(function(d) {
                            var selectedChartOption = getChartTypeSelectionValue();
                            if (DEBUG) {
                                console.log(d.COUNTRY + "," + d.YEAR + "," + d.HEALTH_EXPENDITURE_PER_CAPITA + "," + d.LIFE_EXPECTANCY_AT_BIRTH + "," + d.GOV_DEBT_PCT_OF_GDP + "," + d.GDP_PER_CAPITA + "," + d.IMPORTS_PCT_OF_GDP + "," + d.GOV_ED_SPEND_PCT_GDP);
                                console.log("CHART: " + selectedChartOption)
                            }
                            statToShow = "Don't know what stat to show!!!";
                            colorToShow = "pink";
                            if (selectedChartOption == "HEALTH_EXPENDITURE_PER_CAPITA") {
                                statToShow = d.HEALTH_EXPENDITURE_PER_CAPITA;
                                colorToShow = green_colors_health_expenditures;
                            } else if (selectedChartOption == "LIFE_EXPECTANCY_AT_BIRTH") {
                                statToShow = d.LIFE_EXPECTANCY_AT_BIRTH;
                                colorToShow = red_colors_life_exp_at_birth;
                            } else if (selectedChartOption == "GOV_DEBT_PCT_OF_GDP") {
                                statToShow = d.GOV_DEBT_PCT_OF_GDP;
                                colorToShow = purple_colors_debt_gdp;
                            } else if (selectedChartOption == "GDP_PER_CAPITA") {
                                statToShow = d.GDP_PER_CAPITA;
                                colorToShow = yellow_colors_gdp_per_capita;
                            } else if (selectedChartOption == "IMPORTS_PCT_OF_GDP") {
                                statToShow = d.IMPORTS_PCT_OF_GDP;
                                colorToShow = orange_colors_imports_2_gdp;
                            } else if (selectedChartOption == "GOV_ED_SPEND_PCT_GDP") {
                                statToShow = d.GOV_ED_SPEND_PCT_GDP;
                                colorToShow = blue_colors_education_pct_gdp;
                            }

                            countryColors[d.COUNTRY] = colorToShow[Math.floor(statToShow % colorToShow.length)];
                        });

                        repaintMap(countryColors);
                    });
                }

                function playYears() {
                    document.getElementById('yearRange').value = 1960;
                    showForYears(1960, 2015);
                }

                function showForYears(currentYear, endYear) {
                    //console.log("YEAR: " + currentYear);
                    d3.select("#currentYearHeader").text(currentYear);
                    document.getElementById('yearRange').stepUp();
                    updateAll(currentYear);
                    if (currentYear < endYear) {
                        setTimeout(showForYears, ANIMATION_TIMEOUT, ++currentYear, endYear);
                    }
                }

                d3.select("#yearRangePlayBtn").on("click", function() {
                    playYears();
                });


                function getCountryFillColor(obj, countryColors) {
                    if (countryColors[countryById[obj.id]]) {
                        console.log("returning color: " + countryColors[countryById[obj.id]])
                        return countryColors[countryById[obj.id]];
                    }
                    return "#CCCCCC";
                }

                function repaintMap(countryColors) {

                    console.log("---------> repaintMap");
					initSVG();
                    var world = svg.selectAll("path.land").data(countries).enter().append("path").attr("class", "land").attr("d", path).attr("fill", function(d) {
                            return getCountryFillColor(d, countryColors);
                        })

                        //Drag event
                        .call(d3.behavior.drag()
                            .origin(function() {
                                var r = projection.rotate();
                                return {
                                    x: r[0] / sens,
                                    y: -r[1] / sens
                                };
                            })
                            .on("drag", function() {
                                var rotate = projection.rotate();
                                projection.rotate([d3.event.x * sens, -d3.event.y * sens, rotate[2]]);
                                svg.selectAll("path.land").attr("d", path);
                                svg.selectAll(".focused").classed("focused", focused = false);
                            }))

                        //Mouse events
                        .on("mouseover", function(d) {
                            var chartTypeSelectedOptionText = getChartTypeSelectionText()
                            countryTooltip.text(chartTypeSelectedOptionText + ": " + countryById[d.id])
                                .style("left", (d3.event.pageX + 7) + "px")
                                .style("top", (d3.event.pageY - 15) + "px")
                                .style("display", "block")
                                .style("opacity", 1);
                        })
                        .on("mouseout", function(d) {
                            countryTooltip.style("opacity", 0)
                                .style("display", "none");
                        })
                        .on("mousemove", function(d) {
                            countryTooltip.style("left", (d3.event.pageX + 7) + "px")
                                .style("top", (d3.event.pageY - 15) + "px");
                        });

                    d3.select("select#charts").on("change", function() {
                        var chartTypeSelectedIndex = document.getElementById("charts");
                        var chartTypeSelectedOption = chartTypeSelectedIndex.options[chartTypeSelectedIndex.selectedIndex].value
                        var chartTypeSelectedOptionText = chartTypeSelectedIndex.options[chartTypeSelectedIndex.selectedIndex].text
                        d3.select("#titleTextID").text(chartTypeSelectedOptionText);
                        setChartColorBox();
                    });

                    d3.select("select#countries").on("change", function() {
                        var rotate = projection.rotate(),
                            focusedCountry = country(countries, this),
                            p = d3.geo.centroid(focusedCountry);

                        svg.selectAll(".focused").classed("focused", focused = false);

                        //Globe rotating

                        (function transition() {
                            d3.transition()
                                .duration(2500)
                                .tween("rotate", function() {
                                    var r = d3.interpolate(projection.rotate(), [-p[0], -p[1]]);
                                    return function(t) {
                                        projection.rotate(r(t));
                                        svg.selectAll("path").attr("d", path)
                                            .classed("focused", function(d, i) {
                                                return d.id == focusedCountry.id ? focused = d : false;
                                            });
                                    };
                                })
                        })();
                    });

                    function country(cnt, sel) {
                        for (var i = 0, l = cnt.length; i < l; i++) {
                            if (cnt[i].id == sel.value) {
                                return cnt[i];
                            }
                        }
                    };


                }


            };
        </script>
        <div><i>(Country is colored gray when statistic is not available)</i></div>
    </div>
</body>

</html>